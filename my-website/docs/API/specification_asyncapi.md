---
title: Описание асинхронного взаимодействия
hide_table_of_contents: true
---


В работе используется RabbitMQ для реализации асинхронного взаимодействия между волонтерами и фондами/организациями в процессе создания и отклика на заявки. Описание взаимодействия

1. Фонд создает заявку на волонтерство и публикует ее.

2. Заявка обрабатывается и становится доступной для волонтеров.

3. Волонтеры могут просматривать доступные заявки и откликаться на них.

4. Если волонтер выбирает заявку, система отображает наличие свободных мест:

5. Если есть свободные места, волонтер добавляется к заявке.

6. Если мест нет, волонтер встает в очередь ожидания. При этом происходит отправка сообщения в очередь 1. Также есть очередь 2, в которой будет информация об освободившихся свободных местах.

7. Если другой волонтер отказался, то рассылаются пуши волонтерам из очереди 1. Если какие-то из волонтеров, которые были в листе ожидания, откликнулись на заявку, то сервис отправляет результат в очередь 2.

### Контракт для брокера сообщений (RabbitMQ)

1. **Очередь 1 - Заявки в лист ожидания** volunteer_waiting_queue_exchange

  - **Описание**: Эта очередь используется для обработки запросов волонтеров, которые хотят встать в очередь ожидания, если на момент отклика нет свободных мест.

  - **Сообщение**:

    - **Тип сообщения**: JSON

    - **Параметры**:

      - `user_id`: идентификатор волонтера.

      - `application_id`: идентификатор заявки.

      - `timestamp`: время отклика.

  - **Пример**:

    ```Plain Text

{
  "user_id": "volunteer123",
  "application_id": "application_id123",
  "timestamp": "2024-12-08T12:30:00"
}
```


2. **Очередь 2 - Освободившиеся места и уведомления** volunteer_notification_exchange

  - **Описание**: Когда место в заявке становится свободным (волонтер отказался), система отправляет уведомления пользователям, стоящим в листе ожидания, через эту очередь.

  - **Сообщение**:

    - **Тип сообщения**: JSON

    - **Параметры**:

      - `application_id`: идентификатор заявки.

      - `user_id`: идентификатор волонтера, которому можно предложить место.

      - `status`: статус (например, "место доступно", "не выбрал").

      - `timestamp`: время уведомления.

  - **Пример**:

    ```Plain Text

{
  "application_id": "application_id123",
  "user_id": "volunteer789",
  "status": "место доступно",
  "timestamp": "2024-12-08T14:00:00"
}
```


### Описание работы с очередями:

3. Когда **фонд создает заявку**, сервис отправляет сообщение в очередь 1, которая сигнализирует, что заявка доступна для отклика волонтерам.

4. Когда **волонтер откликается на заявку**, система проверяет наличие свободных мест. Если мест нет, сообщение отправляется в очередь 1 (волонтер становится в лист ожидания).

5. При **освобождении места** в заявке, сервис проверяет очередь 1, извлекает пользователей, ожидающих на это место, и рассылает уведомления через очередь 2.

6. **Волонтеры из очереди 1** получают уведомление через очередь 2 и могут откликнуться. Если кто-то откликается, то система сообщает результат в очередь 2.

**Типы сообщений**

- **Message Type 1: Заявка на волонтерство**

  Формат сообщения, отправляемого фондом для создания заявки:

  ```Plain Text

{
  "action": "create_volunteer_application",
  "data": {
    "fund_id": 123,
    "volunteer_application_id": 456,
    "available_spots": 5,
    "application_description": "Помощь в уборке территории парка",
    "application_name": "Помощь в уборке территории",
    "application_date": "2024-12-09",
    "application_starttime": "14:00:00",
    "application_endtime": "18:00:00"
  }
}
```


- **Message Type 2: Отклик волонтера**

  Формат сообщения, отправляемого волонтером для отклика на заявку:

  ```Plain Text

{
  "action": "volunteer_response",
  "data": {
    "volunteer_id": 789,
    "volunteer_application_id": 456,
    "status": "accepted"
  }
}
```


- **Message Type 3: Ожидание волонтера**

  Формат сообщения, когда волонтер встает в очередь ожидания (если нет свободных мест):

  ```Plain Text

{
  "action": "volunteer_waiting",
  "data": {
    "volunteer_id": 789,
    "volunteer_application_id": 456,
    "status": "waiting"
  }
}
```


- **Message Type 4: Уведомление о свободном месте**

  Формат сообщения, отправляемого системой, когда освободилось место для волонтера:

  ```Plain Text

{
  "action": "notify_free_spot",
  "data": {
    "volunteer_application_id": 456,
    "available_spots": 1,
    "waiting_volunteers": [789, 1011]
  }
}
```



